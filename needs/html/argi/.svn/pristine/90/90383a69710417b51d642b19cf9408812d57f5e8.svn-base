<!DOCTYPE html>
<html class="no-js">
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<meta name="format-detection" content="telephone=no,email=no,date=no,address=no">
		<link rel="stylesheet" type="text/css" href="../../../res/css/aui.css"/>
		<link rel="stylesheet" type="text/css" href="../../../res/themes/aui-theme-style1.css"/>
		<!--<script type="text/javascript" src="../../../script/rem.js"></script>-->
		<style>
		
		  #headshot{
		   width:4rem;
		   padding:0 !important;
		   height: 5.2rem;
		   text-align: center;
		   line-height: 5.2rem;
		   margin-top:10px;
		   margin-right:0.5rem;
		  }
		   #headshot i{
		    width:100%;
		    height:100%;
		    font-size:20px;
		    font-weight:700;
		    color: #20c714;
		   }
		  #headshot img{
		    width:100%;
		    height:100%;
		   }
		   /*.aui-pull-left span{
		   		width:14px;
		   		height:18px;
		   		border:solid 1px red;
		   		overflow:hidden;
		   		background-position:center center;
		   		background-size:90% 80%;
		   }*/
		  
		   .leftBack{
		   		display: inline-block;
				position: absolute;
				left: 13px;
				bottom: 14px;
				width: 12px;
				height: 19px;
				background-image: url(../../../image/harvest_back.png);
				background-position: center;
				background-size: 100% 100%;
				background-repeat: no-repeat; 
		   }
		   .aui-bar-nav .aui-btn.red{
		          color: #d0d0d0;
		   }
		   #aui-parent{font-size:0;}
		   #aui-parent > * {font-size:0.7rem;}
		   #aui-parent > .aui-btn + .aui-btn{margin-left:0.2rem;}
		   @media screen and (max-width:321px){
		   	
		   		#aui-parent .aui-btn{padding-left:0.2rem;padding-right:0.2rem;}
		   		.aui-list .aui-list-item-input.max320{width:90%;}
		   }
		   .img-upload-wrap{width:100%;padding-top: 1.5rem;}
		   .img-upload{
		   	padding:0;
		   	margin:0;
		   	line-height:20px;
		   }
		  @media screen and (max-width:400px){
		  	.sm-400 .aui-btn{
		  		padding:0 0.4rem;
		  	}
		  }
		  	header{
		  	    z-index:9999;
				position: fixed;
				left: 0;
				top: 0;
				width: 100%;
				height:68px;
				background: #00c558;
			}
			/*header #top{
				width: 100%;
				height: 0.46rem;
				background: #00c558;
			}*/
			header #title{
				position: relative;
				width:100%;
				height: 68px;
				line-height: 68px;
				text-align: center;
				font-size: 18px;font-family: PingFangSC-Regular, sans-serif;color: #fff;
			}
			header #title span{
				display: inline-block;
				position: absolute;
				left: 13px;
				bottom: 20px;
				width: 12px;
				height: 18px;
				background-image: url(../../../image/harvest_back.png);
				background-position: center;
				background-size: 100% 100%;
				background-repeat: no-repeat;
			}
		</style>
	</head>
	<body >

		<section class="aui-content" style="background-color: #fff;">

		<!--<section class="aui-content" style="margin-bottom:3.2rem;margin-top: 46px;">-->


			<div class="top-slogan">
				<img src="../../../res/image/banner-img.png" alt="" />
			</div>
			<section class="aui-content-padded aui-content-margin5" style="margin-top: -2rem">
				<div class="aui-list aui-collapse aui-content-radius" style="padding-top:1.5rem;padding-bottom: 0.5rem">
					<!--基础信息-->
					<div class="aui-collapse-item">
						<div class="aui-list-item-inner">
							<div class="aui-list-item-title">
								<span class="item-title-inner">基础信息</span>
							</div>
							<div class="aui-list-item-right aui-collapse-header aui-active sm-400">
								<span class="aui-btn aui-btn-green-gray aui-active show1"> <i class="aui-iconfont aui-icon-down aui-collapse-arrow"style="-webkit-transform:rotate(0deg)"></i> <span class="aui-show1">点我收起 </span><!-- <span class="aui-active-open">点我展开</span> --></span>
							</div>
						</div>
						<div class="aui-collapse-content aui-padded-10 aui-show">
							<ul class="aui-list-item-wrap basMes">
								
								<li>
									<div class="aui-list-item-inner">
										<div class="aui-list-item-label width-auto2">
											在哪采收
										</div>
										<div class="aui-list-item-input">
											<div class="select-add-arrow">
												<span class="add-arrow-layer"><i class="aui-iconfont aui-icon-down"></i></span>
												<select id="farmName" >
													<!--<option value="">请选择基地名称</option>-->
												</select>
											</div>
										</div>
									</div>
								</li>
								<li>
									<div class="aui-list-item-inner">
										<div class="aui-list-item-label width-auto2">
											采哪块地
										</div>
										<div class="aui-list-item-input">
											<div class="select-add-arrow">
												<span class="add-arrow-layer"><i class="aui-iconfont aui-icon-down"></i></span>
												<select id="landName">
												<!--	<option value="">请选择地块名称</option>-->
												</select>
											</div>
										</div>
									</div>
								</li>
								<li>
									<div class="aui-list-item-inner">
										<div class="aui-list-item-label width-auto2">
											要采什么
										</div>
										<div class="aui-list-item-input">
											<div class="select-add-arrow">
												<span class="add-arrow-layer"><i class="aui-iconfont aui-icon-down"></i></span>
												<select id="catName">
													<!--<option value="">请选择作物品名</option>-->
												</select>
											</div>
										</div>
									</div>
								</li>
								<li>
									<div class="aui-list-item-inner">
										<div class="aui-list-item-label width-auto2">
											采的品种
										</div>
										<div class="aui-list-item-input">
											<div class="select-add-arrow">
												<span class="add-arrow-layer"><i class="aui-iconfont aui-icon-down"></i></span>
												<select id="categoryName">
												<!--	<option value="">请选择作物品种</option>-->
												</select>
											</div>
										</div>
									</div>
								</li>
							</ul>
						</div>
					</div>
					<!--工人信息-->
					<div class="aui-collapse-item">
						<div class="aui-list-item-inner" style="">
							<div class="aui-list-item-title">
								<span class="item-title-inner">工人信息</span>
							</div>
						</div>
						<div class="aui-list-content-ctp">
							<ul class="aui-list-item-wrap">
								<li class="" style="display: block;">
									<div class="aui-media-list-item-inner" style="position: relative">
										<!--工人图片-->
										<div class="aui-list-item-media" id="headshot">
										<div class="img-upload-wrap">
									        <p class="img-upload"><i class="aui-iconfont aui-icon-plus"></i></p>
									        <p class="img-upload">上传照片</p>
								        </div>
												<!--<img src="../../../image/pic1.png">-->
										</div>
										<div id="delPic" style="display:none;">
											<i class="aui-iconfont aui-icon-close"></i>
										</div>
										<!--工人信息表单S-->
										<div class="aui-list-item-inner" style="display: block;">
											<div class="aui-list-item-text">
												<div class="aui-list-item-inner sm-flex-wrap">
													<div class="aui-list-item-label width-auto">
														姓名
													</div>
													<div class="aui-list-item-input max320">
														<input id="name" maxlength="10" type="text" class="aui-input-sm" placeholder="请输入姓名">
													</div>
													<div class="aui-list-item-label width-auto">
														性别
													</div>
													<div class="aui-list-item-input"style="width:90%;">
														<label>
															<input class="aui-radio aui-radio-sm" type="radio" name="sex" value="1"checked>
															男 </label>
														<label>
															<input class="aui-radio aui-radio-sm" type="radio" name="sex" value="0">
															女 </label>
													</div>
												</div>
											</div>
											<div class="aui-list-item-text">
												<div class="aui-list-item-inner  sm-flex-wrap">
													<div class="aui-list-item-label width-auto" style="min-width:2.9rem;">
														哪种工人
													</div>
													<div class="aui-list-item-input"style="width:94%;">
														<label>
															<input class="aui-radio aui-radio-sm" type="radio" name="work"value="1" checked>
															包工 </label>
														<label>
															<input class="aui-radio aui-radio-sm" type="radio" name="work"value="2">
															日工 </label>
													</div>
													<!--<div class="aui-list-item-label width-auto aui-label-hide">
														费用
													</div>-->
													<div class="aui-list-item-input aui-list-item-input-sm">
														<div class="select-add-arrow">
															<input id="cost" style="font-size: 0.55rem;"class="aui-input-sm" readonly  type="text" placeholder="">
														</div>
													</div>
												</div>
											</div>
											<div class="aui-list-item-text">
												<div class="aui-list-item-inner  sm-flex-wrap">
													<div class="aui-list-item-label width-auto">
														手机号
													</div>
													<div class="aui-list-item-input">
														<input id="phone" maxlength="11" class="aui-input-sm" type="number" onkeyup='this.value=this.value.replace(/[^\d]/gi,"")' placeholder="请输入手机号">
													</div>
												</div>
											</div>
										</div><!--工人信息表单E-->
									</div>
								</li>
							</ul>
						</div>
					</div>
					<!--记工信息-->
					<div class="aui-collapse-item">
						<div class="aui-list-item-inner aui-active" style="margin-top: 0.68rem;margin-bottom: 0.5rem;">
							<div class="aui-list-item-title">
								<span class="item-title-inner">记工信息</span>
							</div>
							<div class="aui-list-item-right">
								<span id="gradeCheck" class="aui-text-warning">作物等级划分查看</span>
							</div>
						</div>
						<div id="aui-parent" class="aui-active text-left aui-btns-group">
						<div class="aui-row sm-400">
							<div class="aui-col-xs-4 text-left">
								<span id="addRecord" class="aui-btn aui-btn-green-gray"><i class="aui-iconfont aui-icon-plus aui-icon-bold"></i>新增记工</span>
							</div>
							<div class="aui-col-xs-4 text-center">
								<span id="history" class="aui-btn aui-btn-green-gray" onclick="history1()"><i class="btn-font-icon notes-icon"></i>我都记了啥</span>
							</div>
							<div class="aui-col-xs-4  text-right">
								<span id="addactive" class="aui-btn aui-btn-green-gray aui-active aui-collapse-header show2"><i class="aui-iconfont aui-icon-down aui-collapse-arrow"></i><span class="info-text aui-show2">点我展开 </span></span>
							</div>
						</div>  
							<!--提示-->
							<div class="bright-tips text-left"  style="padding:0.5rem">
								<i class="bright-tips-icon"></i><span class="bright-tips-info">小贴士：多记工怎么办？可新增记工明细录入负数来解决哦~</span>
							</div>

						</div>
						<div class="aui-collapse-content aui-padded-10" id="data">
							<div id="hisList"></div>
							<div id="addList"></div>
						</div>
					</div>
				</div>
			</section>
		</section>
		
	</body>
	<script type="text/javascript" src="../../../script/api.js"></script>
	<script type="text/javascript" src="../../../res/script/aui-collapse.js" ></script>
	<script type="text/javascript" src="../../../script/jquery.min.js"></script>
	<script type="text/javascript" src="../../../script/pds.ajax.js"></script>
	<script type="text/javascript" src="validatorjs.min.js"></script>
	<script type="text/javascript">
		var id;
		var mainId;
		var workerId=null;
		var saved = false;//图片调用
		var needSubmit=false;
		var olgWorkerType;
		var hasSave =0;
		var newImage;//图片实时存书id
		var oldImage;//数据库里图片id
		
		apiready = function() {
			//		沉浸式状态栏
			var header=$api.byId("aui-header");
	        $api.fixStatusBar(header);
		
			api.parseTapmode();
//			var header = $api.byId('aui-header');
//  		$api.fixStatusBar(header);
			id = api.pageParam.id;
			init(id);
			
			api.addEventListener({  // 手机返回键事件
		        name: 'onSaveJobSheet'
		    }, function(ret, err) {
		        //alert('onSaveJobSheet ok')
		        harvesttraeditFrm.onBtnSave();
		    });
		    
		    api.addEventListener({  // 手机返回键事件
		        name: 'onCloseJobSheet'
		    }, function(ret, err) {
		        //alert('onSaveJobSheet ok')
		        closeWin();
		    });
		}
//		var collapse = new auiCollapse({
//			autoHide : false //是否自动隐藏已经展开的容器
//		});
//	
		//=======这块没有改成最新的，还是以前的
		$('.show1').on('click',function(){
		  $('.show1').parent().parent().parent().find('.basMes').slideToggle();
		  var show=$('.show1').find('.aui-show1');
//		  alert("1"+show.text()+"1")
//		  alert(show.text().indexOf("点我收起")>-1)
		  if(show.text().indexOf("点我收起")>-1){
		    show.text("点我展开");
		    $('.show1').find('.aui-icon-down').css('-webkit-transform','rotate(180deg)');
		  }else{
		   show.text("点我收起");
		   $('.show1').find('.aui-icon-down').css('-webkit-transform','rotate(0deg)');
		  }
		})
		
		$('.show2').on('click',function(){
		  $('#data').slideToggle();
		  var show=$('.show2').find('.aui-show2');
		  if(show.text().indexOf("点我收起")>-1){
		    show.text("点我展开");
		    $('.show2').find('.aui-icon-down').css('-webkit-transform','rotate(180deg)');
		  }else{
		   show.text("点我收起");
		   $('.show2').find('.aui-icon-down').css('-webkit-transform','rotate(0deg)');
		  }
		})
		//=======这块没有改成最新的，还是以前的
//		setInterval('saveButton()',5000)
		/*function saveButton(){
		//alert(needConfirm())
			if(needConfirm()){
				//点亮
			$('#save').addClass('red');
			$('#save').removeAttr('disabled','disabled')
			
			}else{
			$('#save').removeClass('red');
			$('#save').prop('disabled','disabled')
			}
		}*/
		function needConfirm(){
			var result = false;
			console.log($($('.mark')[$('.mark').length-1]).attr('hmc'))
			result  = $('.mark').length>0&&$($('.mark')[$('.mark').length-1]).attr('hmc')==undefined;
			console.log(result)
			if(hasSave==1)return result;
			var a = $("#farmName").attr("oldval")||'';
			result = result || a!=$("#farmName").val();
			console.log(result)
//			console.log(a)
//			console.log($("#farmName").val())
            var b = $("#landName").attr("oldval")||'';
            console.log("b="+b)
            console.log("b="+$("#landName").val())
			result = result || b!=($("#landName").val()||'');
			console.log(result)
			var c = $("#catName").attr("oldval")||'';
			result = result || c!=($("#catName").val()||'');
			console.log(result)
			var d = $("#categoryName").attr("oldval")||'';
			result = result || d!=($("#categoryName").val()||'');
			console.log(result)
			result = result || $('#headshot img').attr("data-id")!=oldImage;
			console.log(result)
			var x  = $("input:radio[name='work']:checked").val()!=olgWorkerType&&olgWorkerType!=''&&olgWorkerType!=undefined
			result = result || x;
			console.log(result)
			console.log(olgWorkerType+","+(olgWorkerType==''))
			console.log(result)
			var e = $("#name").prop("readonly")==false&&$("#name").val()!='';
			console.log('$("#name").prop("readonly")='+$("#name").prop("readonly"))
	//		console.log($("#name").val());
//			console.log(e);

			result = result || e;
			console.log(result)
			var f = $("input:radio[name='sex']:checked").prop("disabled")==false&&$("input:radio[name='sex']:checked").val()==0;
//			console.log('$("input:radio[name="sex"]:checked").prop("disabled")='+$("input:radio[name='sex']:checked").prop("disabled"))
//			console.log($("input:radio[name='sex']:checked").val())
console.log(result)
			result = result || f;
//			console.log(f);
console.log(result)
			var g = $("#phone").prop("readonly")==false&&$("#phone").val()!='';
			result = result || g;
			console.log(result)
//			console.log(g);
//			console.log(result);
			return result;
		}
		var orderStatusFlag ;
		
		function closeWin(){
		//alert(orderStatusFlag)
			console.log("$('.mark').length="+$('.mark').length)
			console.log(id)
			if(($('.mark').length==undefined||$('.mark').length==0) && id!=null && id!=undefined){
				//判断orderStatus为未报功
				//1.刚报功，页面退出时解除--->orderStatus=='1'
				//2.本页面保存后退出，不解
				//3.以后再进入页面后退出，不解
				
				if(orderStatusFlag==='1'||orderStatusFlag==='')useable(workerId,0);
				//alert(orderStatusFlag)
			}
		  
		   if(needConfirm()){
		        api.confirm({
				    title: '提示',
				    msg: '您确定要放弃保存吗？',
				    buttons: ['取消', '确定']
				}, function(ret, err){
				    if( ret ){
				        if(ret.buttonIndex*1 == 1){
				        	return false;
				        }else{
				        	api.closeWin({
									});
					         api.execScript({
									name : 'list_win',
									frameName : 'list_win',
									script : 'harvtJobListFrm.initModule()'
								});
				        }
				    }else{
				    	 return false;
				    }
				});
		  }else{
		  		api.closeWin({
				});
		        api.execScript({
					name : 'list_win',
					frameName : 'list_win',
					script : 'harvtJobListFrm.initModule()'
				});
		  }
			
		  
		}
		
		function useable(workerId,useStatus){
			pds.ajaxSubmit({
				url : "app/recordworkorder/update_worker_useable",
				data : {
					'workerId' : workerId,
					'useStatus':useStatus
				},
				success : function(res) {
					//alert(JSON.stringify(res))
					if (res.status == 'ok') {
						var data = res.data;
						console.log((useStatus==0?"解除":"")+"占用成功");
					}else{
						console.log((useStatus==0?"解除":"")+"占用失败");
					}
					}
				});
		}
		
		//基础信息禁用及优化
		  function basMes(){
		            $('#farmName').attr('disabled','disabled');
				    $('#landName').attr('disabled','disabled');
				    $('#catName').attr('disabled','disabled');
				    $('#categoryName').attr('disabled','disabled');
				    $('.basMes').find('.aui-icon-down').hide();
				    $('#farmName').css('border','none').closest(".aui-list-item-input").siblings(".aui-list-item-label").css("width","6.7rem");
				    $('#landName').css('border','none').closest(".aui-list-item-input").siblings(".aui-list-item-label").css("width","6.7rem");;
				    $('#catName').css('border','none').closest(".aui-list-item-input").siblings(".aui-list-item-label").css("width","6.7rem");;
				    $('#categoryName').css('border','none').closest(".aui-list-item-input").siblings(".aui-list-item-label").css("width","6.7rem");;
		}
		
		function init(id) {
		    //alert(id)
			if(id){
			    $('.basMes').hide();
				pds.ajaxSubmit({
						url : "app/recordworkorder/query_work_order_sheet",
						data:{'workerId':id},
						success : function(res) {
							//console.log(JSON.stringify(res))
//							$("#addactive").click(function(){
//								if($("#addactive").hasClass("aui-active")){
//									$(".aui-btn-green-gray.aui-collapse-header").removeClass("aui-active").closest("#aui-parent").siblings(".aui-collapse-content").removeClass("aui-show")
//								}else{
//									$(".aui-btn-green-gray.aui-collapse-header").addClass("aui-active").closest("#aui-parent").siblings(".aui-collapse-content").addClass("aui-show")
//								}
//							})

							$('#data').hide();
							
							if (res.status == 'ok') {
								var data = res.data;
								mainId = data.id;
								workerId = data.harvestWorkerVo.id;
//								useable(workerId,1);
								var farmId = data.farmId;
								$("#farmName").attr("oldval",farmId);
								var landId = data.landId;
								$("#landName").attr("oldval",landId);
								var catalogId = data.catalogId;
								$("#catName").attr("oldval",catalogId);
								var categoryId = data.categoryId;
								$("#categoryName").attr("oldval",categoryId);
								var cost = data.cost;
								$('#cost').val(cost);
								var workerType = data.workerType;
								olgWorkerType = workerType;
								if(workerType)$("input:radio[name='work'][value="+workerType+"]").attr("checked","checked");
								harvesttraeditFrm.configMoule();
					            harvesttraeditFrm.initModule(farmId,landId,catalogId,categoryId);
					            var name=data.harvestWorkerVo.name;
					            $('#name').val(name);
					            var phone=data.harvestWorkerVo.phone;
					            $('#phone').val(phone);
					            var sex=data.harvestWorkerVo.sex;
					            if(sex)$("input:radio[name='sex'][value="+sex+"]").attr("checked","checked");
					            $('#name').attr('readonly','true');
				           		$('#phone').attr('readonly','true');
				           		$("input:radio[name='sex']").attr('disabled','disabled');
							    var url=null;
					            var baseUrl = pds.defaultUri;
					            url = baseUrl.substring(0,baseUrl.length-1);
					            if(data.harvestWorkerVo.basFile!=null){
								   $("#headshot").html("<img src='"+url+"/attach/view/"+data.harvestWorkerVo.basFile.id+"' oldval='"+ data.harvestWorkerVo.basFile.id+"' data-id='"+ data.harvestWorkerVo.basFile.id+"'/>");
								 
								   $('#delPic').css('display','block');
								oldImage=data.harvestWorkerVo.basFile.id;
								}
								orderStatusFlag = data.orderStatus;
								
								//alert(data.orderStatus)
//								alert(data.orderStatus)
//								alert(data.orderStatus==="0")
//								
//								alert(data.harvestWorkRecordList==null||data.harvestWorkRecordList.length==0)
//				           		if(data.orderStatus==="0" &&data.harvestWorkRecordList!=null&&data.harvestWorkRecordList.length!=0){
				           		if(data.orderStatus==="0" ){// 新增人员信息保持不变，报工后修改照片和人工
				           		     basMes();
				           			 saved = true;
				           			 $('#delPic').hide();
				           			
				           			 if($('#headshot img')){ 
										$('#headshot img').click(function(){preview()});
									}
				           			//处理未报功场景
				           			//disable
					                 $('#name').attr('readonly','true');
				           			 $('#phone').attr('readonly','true');
				           			 $("input:radio[name='sex']").attr('disabled','disabled');
				           			 $("input:radio[name='work']").attr('disabled','disabled');
				           			 // 展示未报功记录
				           			 var harvestWorkRecordList = data.harvestWorkRecordList;
				           			 if(harvestWorkRecordList){
				           			 	for(var x=0;x<harvestWorkRecordList.length;x++){
				           			 		addEditRecord(harvestWorkRecordList[x]);
				           			 	}
				           			 }
				           		}
				           		$('.basMes').show();
							}
						}
					})
				}else{
				   $('#landName').html('<option value="">请选择地块名称</option>');
				   $('#catName').html('<option value="">请选择作物品名</option>');
				   $('#categoryName').html('<option value="">请选择作物品种</option>');
					harvesttraeditFrm.configMoule();
					harvesttraeditFrm.initModule();
				}
		     }
	  	var harvesttraeditFrm = (function() {
			//模块内部操作dom的所有方法写在这
			setDomMap = function() {
				domMap = {
					$farmName : $api.byId('farmName'),
					$landName : $api.byId('landName'),
					$catName : $api.byId('catName'),
					$categoryName : $api.byId('categoryName'),
					$name : $api.byId('name'),
					$phone : $api.byId('phone'),
					$cost : $api.byId('cost'),
					$headshot : $api.byId('headshot'),
					$addRecord : $api.byId('addRecord'),
					//$save : $api.byId('save'),
					$gradeCheck : $api.byId('gradeCheck'),
					$history : $api.byId('history'),
				}
				//dom操作
					$api.addEvt(domMap.$farmName, 'change', onBtnland);
					$api.addEvt(domMap.$farmName, 'change', onBtncatName);
					$api.addEvt(domMap.$farmName, 'change', onBtnCost);
					$("input:radio[name='sex']").change(function() {
						onBtnCost();
					});
					$("input:radio[name='work']").change(function() {
						onBtnCost();
					});
					$api.addEvt(domMap.$farmName, 'change', getNewGrade);
					$api.addEvt(domMap.$catName, 'change', onBtncategoryName);
					$api.addEvt(domMap.$categoryName, 'change', getNewGrade);
					$api.addEvt(domMap.$headshot, 'click', getPicture);
					$api.addEvt(domMap.$addRecord, 'click', addRecord);
					//$api.addEvt(domMap.$save, 'click', onBtnSave);
					$api.addEvt(domMap.$gradeCheck, 'click', gradeCheck);
					$api.addEvt($api.byId('delPic'), 'click', delPic);
				    $api.addEvt(domMap.$history, 'click', history);
			}
			
			back = function(e) {
				api.closeWin({
				});
			}
			delPic = function(e) {
				var picId = $('#headshot img').attr('data-id');
				pds.ajaxSubmit({
					url : "app/recordworkorder/delete_worker_pic",
					data : {
						'picId' : picId
					},
					success : function(res) {
						if (res.status == 'ok') {
							$('#headshot img').remove();
							api.alert({
								msg : "图片删除成功"
							});
							$("#headshot").html('<div class="img-upload-wrap"><p class="img-upload"><i class="aui-iconfont aui-icon-plus"></i></p><p class="img-upload">上传照片</p></div>');
							$('#delPic').css('display','none')
						}
					}
				})
			}
			//回显未报工
			addEditRecord = function(obj) {
			     var num=obj.standardNumber+obj.numeratorName+'／'+obj.denominatorName;
			      if(obj.denominatorName==''||obj.denominatorName==null){
			         obj.denominatorName='';
			         num=obj.standardNumber+obj.numeratorName;
			     }
				var str = '';
				 	 str += '<div class="aui-infos-item">';
	                	 str +='<div class="aui-list-item-inner">';
		                    str += ' <div class="aui-list-item-label">记工日期</div>';
		                     str += '<div class="aui-list-item-input">'+(obj.recordDate.substring(0,obj.recordDate.length-3))+'</div>';
		                str += ' </div>';
		                str += ' <div class="aui-list-item-inner">';
		                   str += '  <div class="aui-list-item-label">规格数量</div>';
		                    str += ' <div class="aui-list-item-input">'+num+'</div>';
		                 str += '</div>';
		                 for(var x=0;x<obj.harvestWorkRecordDetailsVoList.length;x++){
		                 	var per = obj.harvestWorkRecordDetailsVoList[x];
		                 	str += ' <div class="aui-list-item-inner">';
			                  str += '   <div class="aui-list-item-label" style="white-space: normal;line-height: 0.8rem;">'+per.gradeName+'</div>';
			                   str += '  <div class="aui-list-item-input" style="'+(per.harvestNumber<0?'color:red;':'')+'">'+per.harvestNumber+per.unitName+'</div>';
			                 str += '</div>';
           			 	}
	                 str += '</div>';
				$('#hisList').append(str);
			}
			
			//新增记工
			var i = 0;
			addRecord = function(e) {
				var copy = false;
				if($('.mark').length>0&&!$($('.mark')[$('.mark').length-1]).attr("hmc")){
					copy = true;
				}
			   var molecular=copy?$($(".molecular")[$(".molecular").length-1]).val():null;
			   var denominator=copy?$($(".denominator")[$(".denominator").length-1]).val():null;
			   var flag = $($(".molecular")[$(".molecular").length-1]).attr('flag');
			   var harNumber=copy?$($(".harNumber_"+flag)[0]).val():'';
			   var unit=copy?$($(".unit_"+flag)[0]).val():null;
			   var unitId=copy?$($(".unit_"+flag)[0]).attr('data-id'):null;
			   if(unit==undefined){
			     unit='';
			     unitId=''
			   }
			   $('#data').show();
//			   if(!$(".aui-btn-green-gray.aui-collapse-header").hasClass("aui-active")){
//			   		$(".aui-btn-green-gray.aui-collapse-header").addClass("aui-active").closest("#aui-parent").siblings(".aui-collapse-content").addClass("aui-show")
//			   }
				var str = '';
				needSubmit=true;
				str += '<ul class="aui-infos-item-form mark"><li>';
				    str += '<div class="aui-infos-item-form-left aui-padded-l-10 left">';
				        str += '<div class="aui-list-item-inner line1">';
				         str += '<div class="aui-list-item-label width-auto2">记工日期</div>';
			            	str += '<div class="aui-list-item-input" style="margin-left:-3px;">';
			              	str += '<input type="text" readonly class="date date_' + i + ' aui-control-input" placeholder="" />';
				str += '</div></div>';
				str += '<div class="aui-list-item-inner line2">';
				str += '<div class="aui-list-item-label width-auto2">规格数量</div>';
				str += '<div class="aui-list-item-input input-padded-8" style="width:36%;">';
				str += '<input type="text"  style="border:solid 1px #b8c1b7;height: 1.8rem;" value="'+harNumber+'"onkeyup="parseNum(this)" class="harNumber harNumber_'+i+' aui-control-input" />';
				str += '</div>';
				str += '<div class="aui-list-item-input input-padded-8" style="width:30%;">';
				str += '<div class="select-add-arrow">';
				str += '<span class="add-arrow-layer"><i class="aui-iconfont aui-icon-down"></i></span>';
				str += '<select onchange="getUnit(this)" style="font-size:0.6rem;" flag='+i+' class="molecular molecular_' + i + ' aui-control-select"><option value ="">请选择</option></select>';
				str += '</div></div>';
				str += '<div class="aui-list-item-input input-padded-8" style="width:4%;">/</div>';
				str += '<div class="aui-list-item-input" style="width:30%;padding-right:4px;">';
				str += '<div class="select-add-arrow">';
				str += '<span class="add-arrow-layer"><i class="aui-iconfont aui-icon-down"></i></span>';
				str += '<select onchange="getUnit(this)" class="denominator denominator_' + i + ' aui-control-select"style="font-size:0.6rem;"><option value ="">请选择</option></select>';
				str += '</div></div></div>';
				str += '<div class="aui-list-item-inner addLine line3" style="justify-content: flex-start;">';
				
				str += '<div class="aui-list-item-input input-padded-8 input-hack320" style="width:50.5%;">';
				str += '<div class="select-add-arrow">';
				str += '<span class="add-arrow-layer"><i class="aui-iconfont aui-icon-down"></i></span>';
				str += '<select class="grade grade_' + i + ' aui-control-select"><option value ="">商品分级标准</option></select>';
				str += '</div></div>';
				str += '<div class="aui-list-item-input input-hack320-w1" style="width:20.7%;padding-right:0;">';
				str += '<input type="text" onkeyup="minus(this)"style="border:solid 1px #b8c1b7;height: 1.8rem;" value="" class="gradeNum gradeNum_'+i+' aui-control-input" />';
				str += '</div>';
				str += '<div class="aui-list-item-input" style="width:8%;padding-right:0;"><input readonly  type="text" data-id="'+unitId+'" value="'+unit+'"style="border:none;"class="unit unit_'+i+' aui-control-input" /></div>';
				str += '<div class="aui-list-item-input delete" style="display:none;width:20%;padding-left:0;border:1px solid #ff7600;border-radius: 100px;font-size: 0.8rem;font-weight: 400;">';
			           str+='<span class="delt-icon" onclick="delPlus(this)"><i class="aui-iconfont aui-icon-trash"></i>删除</span>';
			     str+='</div>';
				str += '</div></div>';
				str+='<div class="aui-col-xs-6 right" style="text-align:center;padding-bottom:10px;padding-top:6px" >';
                			str+='<span class="aui-btn aui-btn-outlined aui-btn-sm-green-gray" onclick="addPlus(this)" style="width:108px; height:33px;border-color:#27d94b;font-size:0.8rem;">新增采收量</span>';
                		str+='</div>';
                		
				str += '<div class="aui-col-xs-6 right" style="text-align:center;padding-bottom:10px;padding-top:6px">';
				str += '<span onclick="delLine(this)" class="aui-btn aui-btn-outlined aui-btn-sm-green-gray" style=" width:108px; height:33px; background: #27d94b !important; border-color:#27d94b;font-size:0.8rem; color:#fff;">我记错了</span></div></li></ul>';
				$('#addList').append(str);
				getDate(i);
				getMolecular(i,molecular);
				getDenominator(i,denominator);
				getGrade(i);
				i++;
			}
			//添加按钮
			addPlus = function(obj) {
				var html = $(obj).parent().parent().find('.line3:eq(0)').clone();
				//console.log($(obj).parent().parent().find('.line3:eq(0)').html())
				var val = html.find('.gradeNum').val('');
				$(obj).parent().parent().find('.line3:eq(-1)').after(html);
				//$(obj).remove();
				$(obj).parent().parent().find('.line3 .delete').show();
			}
			
			//删除等级一行
			delPlus=function(obj){
			  var val=$(obj).parent().parent().parent();
			  api.confirm({
		                 title: '提示',
		                   msg: '真的要删除这条记工明细吗？',
		               buttons: ['取消', '确定']
		             }, function(ret, err) {
		               var index = ret.buttonIndex;
		               if(index==2){
		                  $(obj).parent().parent().remove();
		                  }
		                 // alert(val.find('.delete').length)
			    if(val.find('.delete').length==1){
			     val.find('.delete').hide();
			      }
		       })
			}
			//删除记工单我记错了
			delLine = function(obj) {
			     api.confirm({
		                 title: '提示',
		                   msg: '此条记工信息删掉后，只能重新记哦~',
		               buttons: ['取消', '确定']
		             }, function(ret, err) {
		               var index = ret.buttonIndex;
		               if(index==2){
		                   $(obj).closest('ul').remove();
		                  }
		               })
			}
			
			parseNum = function(obj){
				var val = obj.value;
				val=val.replace(/[^\d\.]/gi,"");
				if(val.indexOf(".")>-1 && (val.length-val.substring(0,val.indexOf(".")).length)>3){
					val = val.substring(0,val.indexOf(".")+3);
				}	
				if(val.split(".").length>2){
					val= val.substring(0,val.lastIndexOf("."));
				}
				if(val.indexOf(".")==0){
					val = val.substring(1,val.length)
				}
				obj.value=val;
			}
			   minus= function(obj){
				var val = obj.value;
				val=val.replace(/[^\d\.\-]/gi,"");
				if(val.indexOf(".")>-1 && (val.length-val.substring(0,val.indexOf(".")).length)>3){
					val = val.substring(0,val.indexOf(".")+3);
				}	
				if(val.split(".").length>2){
					val= val.substring(0,val.lastIndexOf("."));
				}
				if(val.lastIndexOf("-")>0){
					val= val.substring(0,val.lastIndexOf("-"));
				}
				if(val.indexOf(".")==0){
					val = val.substring(1,val.length)
				}
				if(val.indexOf("-.")==0){
					val = val.substring(0,1)
				}
				obj.value=val;
			}
			//基地下拉
			onBtnfarm = function(farmId,landId,catalogId,categoryId) {
//				$api.html(domMap.$farmName, '<option value="">请选择基地名称</option>');
				pds.ajaxSubmit({
					url : "app/recordworkorder/queryFarmlist",
					success : function(res) {
						$api.html(domMap.$farmName, '<option value="">请选择基地名称</option>');
						if (res.status == 'ok') {
							var data = res.data;
							if (!data){
								return
							}
							for (var i = 0; i < data.length; i++) {
								var str = '<option value="' + data[i].id + '" '+(farmId==data[i].id?'selected':'')+'>' + data[i].farmName + '</option>';
								$api.append(domMap.$farmName, str);
							}
						}
					}
				})
				if(farmId){
				  onBtnland(farmId,landId);
				  onBtncatName(farmId,catalogId,categoryId);
				}
			}
			//地块下拉
			onBtnland = function(farmId1,landId) {
			    //解决基地为请选择时重复弹出请选择基地提示操作
			    var el=$('#farmName option:eq(0)');
			    if(el.text()=="请选择基地名称")
			       el.remove();
			    //
				$api.html(domMap.$landName, '<option value="">请选择地块名称</option>');
				var farmId;
				if(farmId1 && typeof farmId1 != 'object'){
				   farmId=farmId1;
				}else{
				   farmId=$api.val(domMap.$farmName);
				   if(farmId==''){
				     api.alert({
				       msg:'请选择在哪采收'
				     })
				     return;
				   }
				}
				pds.ajaxSubmit({
					url : "app/land/list",
					data : {
						'landfarmId' : farmId
					},
					success : function(res) {
						if (res.status == 'ok') {
							var data = res.data;
							for (var i = 0; i < data.length; i++) {
								var str = '<option value="' + data[i].id + '"'+(landId==data[i].id?'selected':'')+'>' + data[i].landName + '</option>';
								$api.append(domMap.$landName, str);
							}
						}
					}
				})
			}
			//品名下拉
			onBtncatName = function(farmId1,catalogId,categoryId) {
				$api.html(domMap.$catName, '<option value="">请选择作物品名</option>');
				$api.html(domMap.$categoryName, '<option value="">请选择作物品种</option>');
				var farmId;
				if(farmId1 && typeof farmId1 != 'object'){
				   farmId=farmId1;
				}else{
				   farmId= $api.val(domMap.$farmName);
				    if(farmId==''){
				     api.alert({
				       msg:'请选择在哪采收'
				     })
				     return;
				   }
				}
				console.log(farmId1)
				console.log(farmId)
				pds.ajaxSubmit({
					url : "app/farmingdataresource/coprList",
					data : {
						'farmId' : farmId
					},
					success : function(res) {
						if (res.status == 'ok') {
							var data = res.data;
							console.log(JSON.stringify(data))
							if (data == '') {
								$api.html(domMap.$categoryName, '<option value="">请选择作物品种</option>');
							} else {
								for (var i = 0; i < data.length; i++) {
									var str = '<option value="' + data[i].id + '"'+(catalogId==data[i].id?'selected':'')+'>' + data[i].catName + '</option>';
									$api.append(domMap.$catName, str);
								}
							}
						}
					}
				})
				if(catalogId){
				  onBtncategoryName(catalogId,categoryId)
				}
			}
			//品种下拉
			onBtncategoryName = function(catalogId,categoryId) {
				$api.html(domMap.$categoryName, '<option value="">请选择作物品种</option>');
				var catId;
				if(catalogId && typeof catalogId != 'object'){
				   catId=catalogId;
				}else{
				   catId= $api.val(domMap.$catName);
				    if(catId==''){
				     api.alert({
				       msg:'请选择要采什么'
				     })
				     return;
				   }
				}
				//var catId = $api.val(domMap.$catName);
				pds.ajaxSubmit({
					url : "app/recordworkorder/getSubCatList",
					data : {
						'catId' : catId
					},
					success : function(res) {
						//alert(JSON.stringify(res))
						if (res.status == 'ok') {
							var data = res.data;
							for (var i = 0; i < data.length; i++) {
								var str = '<option value="' + data[i].id + '"'+(categoryId==data[i].id?'selected':'')+'>' + data[i].catName + '</option>';
								$api.append(domMap.$categoryName, str);
								
							}
						}
					}
				})
			}
			getPicture = function() {
			     if(saved) {
			     	return;
			     }
				//获取一张图片
				api.getPicture({
					sourceType : 'camera',
					encodingType: 'jpg',
					mediaValue : 'pic',
					allowEdit : false,
					quality : 10,
					saveToPhotoAlbum : true
				}, function(ret, err) {
					// 获取拍照数据并处理
					//alert(JSON.stringify(ret))
					if (ret) {
						if (ret && ret.data != "") {
							$('#headshot').text('上传中...');
							pds.ajaxSubmit({
								url : "attach/upload",
								fileData : {
									file : ret.data
								},
								success : function(e) {
									if (e) {
										var data = e.data;
										//alert(JSON.stringify(data));
										$('#headshot').empty();
										$('#headshot').append('<img style=""data-id="' + data.id + '" src="' + ret.data + '">');
									    $('#delPic').css('display','block');
									} else {
										$('#headshot').html('上传失败...');
									}
								},
								error : function(e) {
									api.alert({
										msg : "服务器异常，请联系管理员!!!"
									});
								}
							});
						}
					}
				});
			}
			gradeCheck = function(e) {
				var farmId = $api.val(domMap.$farmName);
				var catId = $api.val(domMap.$categoryName);
				if (farmId == '' || catId == '') {
				  api.alert({
				   msg:'请先选择基础信息！'
                  });
                 return false;
				}
				$api.openWin({
					name : "xb_levelStandard_home",
					url : "widget://html/harvest/harvest_level.html",
					reload : true,
					selecteIndex : '3',
					pageParam : {
						'farmId' : farmId,
						'catId' : catId
					},
					slidBackEnabled : false,
					animation : {
						type : "movein", //动画类型（详见动画类型常量）
						subType : "from_right", //动画子类型（详见动画子类型常量）
						duration : 300 //动画过渡时间，默认300毫秒
					}
				});
			}
				history1 = function(e) {
				 if(workerId==null){
				    api.alert({
				       msg:' 请先保存工人信息！'
                     });
				      return false;
				    }			
				$api.openWin({
					name : "history-record-check",
					url : "widget://html/harvest/history-record-check.html",
					reload : true,
					selecteIndex : '3',
					pageParam : {
						'workerId': workerId
					},
					slidBackEnabled : false,
					animation : {
						type : "movein", //动画类型（详见动画类型常量）
						subType : "from_right", //动画子类型（详见动画子类型常量）
						duration : 300 //动画过渡时间，默认300毫秒
					}
				});
			}
			
		
			//编辑上传照片
			//			getPic = function() {
			//				api.actionSheet({
			//					title : '上传图片',
			//					cancelTitle : '取消',
			//					buttons : ['拍照', '从手机相册选择']
			//				}, function(ret, err) {
			//					if (ret) {
			//						getPicture(ret.buttonIndex);
			//					}
			//				});
			//			}
			//上传方式
			//			getPicture = function(sourceType) {
			//				if (sourceType == 1) {// 拍照
			//					//获取一张图片
			//					api.getPicture({
			//						sourceType : 'camera',
			//						encodingType : 'png',
			//						mediaValue : 'pic',
			//						allowEdit : false,
			//						quality : 90,
			//						saveToPhotoAlbum : true
			//					}, function(ret, err) {
			//						// 获取拍照数据并处理
			//						//alert(JSON.stringify(ret))
			//						if (ret) {
			//							if (ret && ret.data != "") {
			//								$('#headshot').text('上传中...');
			//								pds.ajaxSubmit({
			//									url : "attach/upload",
			//									fileData : {
			//										file : ret.data
			//									},
			//									success : function(e) {
			//										if (e) {
			//											var data = e.data;
			//											//alert(JSON.stringify(data));
			//											$('#headshot').empty();
			//											$('#headshot').append('<img data-id="' + data.id + '"src="' + ret.data + '">');
			//										} else {
			//											$('#headshot').html('上传失败...');
			//										}
			//									},
			//									error : function(e) {
			//										api.alert({
			//											msg : "服务器异常，请联系管理员!!!"
			//										});
			//									}
			//								});
			//							}
			//						}
			//					});
			//				} else if (sourceType == 2) {
			//					// 从相机中选择
			//					//UIMediaScanner 是一个多媒体扫描器，可扫描系统的图片、视频等多媒体资源
			//					var obj = api.require('UIMediaScanner');
			//					obj.open({
			//						//返回的资源种类,picture（图片）,video（视频）,all（图片和视频）
			//						type : 'picture',
			//						//（可选项）图片显示的列数，须大于1
			//						column : 4,
			//						max : 1,
			//						//（可选项）图片排序方式,asc（旧->新）,desc（新->旧）
			//						sort : {
			//							key : 'time',
			//							order : 'desc'
			//						},
			//						//（可选项）模块各部分的文字内容
			//						texts : {
			//							stateText : '已选择*项',
			//							cancelText : '取消',
			//							finishText : '完成'
			//						},
			//						styles : {
			//							bg : '#fff',
			//							mark : {
			//								icon : '',
			//								position : 'bottom_right',
			//								size : 20
			//							},
			//							nav : {
			//								bg : '#eee',
			//								stateColor : '#000',
			//								stateSize : 18,
			//								cancleBg : 'rgba(0,0,0,0)',
			//								cancelColor : '#000',
			//								cancelSize : 18,
			//								finishBg : 'rgba(0,0,0,0)',
			//								finishColor : '#000',
			//								finishSize : 18
			//							}
			//						}
			//					}, function(ret) {
			//						// 获取图片数据并处理
			//						if (ret) {
			//							//							alert(JSON.stringify(ret))
			//							if (ret && ret.list != "") {
			//								$('#headshot').text('上传中...');
			//								pds.ajaxSubmit({
			//									url : "attach/upload",
			//									fileData : {
			//										file : ret.list[0].path
			//									},
			//									success : function(e) {
			//										if (e) {
			//											var data = e.data;
			//											$('#headshot').empty();
			//											//alert(JSON.stringify(data));
			//											$('#headshot').html('<img data-id="' + data.id + '"src="' + ret.list[0].thumbPath + '">')
			//										} else {
			//											$('#headshot').html('上传失败...');
			//										}
			//									},
			//									error : function(e) {
			//										api.alert({
			//											msg : "服务器异常，请联系管理员!!!"
			//										});
			//									}
			//								});
			//							}
			//						}
			//					});
			//				}
			//			}
			//费用下拉
			onBtnCost = function(e) {
				var farmId = $api.val(domMap.$farmName);
				if(farmId==''){
				  api.alert({
				    msg:'请选择基地名称'
				  })
				  return;
				}
				var sex = $("input:radio[name='sex']:checked").val() * 1;
				//性别
				var workerType = $("input:radio[name='work']:checked").val() * 1;
				//工人类型
				pds.ajaxSubmit({
					url : "app/recordworkorder/query_cost_list?farmId=" + farmId + '&sex=' + sex + '&workerType=' + workerType,
					success : function(res) {
						if (res.status == 'ok') {
							var data = res.data;
							$('#cost').val(data);
						}
					}
				})
			}
			//记工日期获取
			getDate = function(i) {
				var date = new Date();
				var year = date.getFullYear();
				var month = date.getMonth() + 1;
				if (month < 10) {
					month = '0' + month;
				}
				var day = date.getDate();
				if (day < 10) {
					day = '0' + day;
				}
				var hour = date.getHours();
				if (hour < 10) {
					hour = '0' + hour;
				}
				var minute = date.getMinutes();
				if (minute < 10) {
					minute = '0' + minute;
				}
				var second = date.getSeconds();
				if (second < 10) {
					second = '0' + second;
				}
				//var val = year + '-' + month + '-' + day + ' ' + hour + ':' + minute + ':' + second;
				var val = year + '-' + month + '-' + day + ' ' + hour + ':' + minute;
				$('.date_' + i).val(val);
			}
			//分子获取
			getMolecular = function(key,val) {
				pds.ajaxSubmit({
					url : "app/recordworkorder/queryUnitDicList",
					success : function(res) {
						//alert(JSON.stringify(res.data))
						if (res.status == 'ok') {
							var data = res.data;
							for (var i = 0; i < data.length; i++) {
								if (data[i].ruleType == '3') {
									var str = '<option value="' + data[i].id + '" '+(val==data[i].id?'selected':'')+'>' + data[i].name + '</option>';
									$('.molecular_' + key).append(str);
								}
							}
						}
					}
				})
			}
			//分母获取
			getDenominator = function(key,val) {
				pds.ajaxSubmit({
					url : "app/recordworkorder/queryUnitDicList",
					success : function(res) {
						if (res.status == 'ok') {
							var data = res.data;
							for (var i = 0; i < data.length; i++) {
								if (data[i].ruleType == '4') {
									var str = '<option value="' + data[i].id + '" '+(val==data[i].id?'selected':'')+'>' + data[i].name + '</option>';
									$('.denominator_' + key).append(str);
								}
							}
						}
					}
				})
			}
			//等级获取
			getGrade = function(key,val) {
				$('.grade_' + key).html('<option value="">商品分级标准</option>')
				var farmId = $api.val(domMap.$farmName);
				var catId = $api.val(domMap.$categoryName);
				 if((!farmId)||(!catId)){
				 	api.alert({
				 		msg:'请先选择基础信息！'
                     });
                     return false;
				 }
				pds.ajaxSubmit({
					url : "app/recordworkorder/query_grade_list?farmId=" + farmId + '&catId=' + catId,
					success : function(res) {
						if (res.status == 'ok') {
							var data = res.data;
							for (var i = 0; i < data.length; i++) {
								// alert(data[i].gradeName)
								// alert(data[i].status)
								if (data[i].status == '1') {
									var str = '<option value="' + data[i].id + '">' + data[i].gradeName + '</option>';
									$('.grade_' + key).append(str);
								}
							}
						}
					}
				})
			}
			//等级刷新
			getNewGrade = function(e) {
				$('.grade').html('<option value="">商品分级标准</option>')
				var farmId = $api.val(domMap.$farmName);
				var catId = $api.val(domMap.$categoryName);
				if((!farmId)||(!catId)){
				  return false;
				}
				pds.ajaxSubmit({
					url : "app/recordworkorder/query_grade_list?farmId=" + farmId + '&catId=' + catId,
					success : function(res) {
						if (res.status == 'ok') {
							var data = res.data;
							for (var i = 0; i < data.length; i++) {
								if (data[i].status == '1') {
									var str = '<option value="' + data[i].id + '">' + data[i].gradeName + '</option>';
									$('.grade').append(str);
								}
							}
						}
					}
				})
			}
			//单位的获取
			getUnit = function(obj) {
				var $UnitVal;
				//值
				var $UnitId;
				//单位id
				//Unit对象
				var $Unit = $(obj).closest('li').find('.unit')
				//分母判断
				if ($(obj).hasClass('denominator')) {
					//分母id
					$UnitId = $api.val(obj);
					if ($UnitId != '') {
						$Unit.attr('data-id', $UnitId);
						$UnitVal = $(obj).find('option:selected').text();
						if($UnitVal=='请选择'){
						 $UnitVal='';
						}
						$Unit.val($UnitVal);
					} else {
						$UnitId = $(obj).closest('li').find('.molecular').val();
						$UnitVal = $(obj).closest('li').find('.molecular').find('option:selected').text();
						$Unit.attr('data-id', $UnitId);
						if($UnitVal=='请选择'){
						 $UnitVal='';
						}
						$Unit.val($UnitVal);
					}
				}
				if ($(obj).hasClass('molecular')) {
					//分母对象
					var $parent = $(obj).closest('li').find('.denominator');
					var $parentId = $parent.val();
					if ($parentId != '') {
						$Unit.attr('data-id', $parentId);
						$UnitVal = $parent.find('option:selected').text();
						if($UnitVal=='请选择'){
						 $UnitVal='';
						}
						$Unit.val($UnitVal);
						
					} else {
						$Unit.attr('data-id', $(obj).val());
						$UnitVal = $(obj).find('option:selected').text();
						if($UnitVal=='请选择'){
						 $UnitVal='';
						}
						$Unit.val($UnitVal);
					}
				}
			}
		
				//点击图片
			 preview=function() {
				imagUrls = [];
			    imagUrls.push($('#headshot img').prop("src"));
				var imageBrowser = api.require('imageBrowser');
				imageBrowser.openImages({
					imageUrls : imagUrls
				});
			}
			
			onBtnSave = function(e) {
				var data = {
					harvestWorkerVo : {
						basFile : {
						},
						id:null
						
					},
					harvestWorkRecordList : []
				};
				
				//基础信息保存
				//基地id
				var farmId = $api.val(domMap.$farmName);
				data.farmId = farmId;
				//地块id
				var landId = $api.val(domMap.$landName);
				data.landId = landId;
				//品名id
				var catId = $api.val(domMap.$catName);
				data.catalogId = catId;
				//品种id
				var categoryId = $api.val(domMap.$categoryName);
				data.categoryId = categoryId;
				var workerType = $("input:radio[name='work']:checked").val() * 1;
				//工人类型
				data.workerType = workerType;
				//费用
				var cost = $api.val(domMap.$cost);
				data.cost = cost;
				//工人信息
				//姓名
				var name = $api.val(domMap.$name);
				data.harvestWorkerVo.name = name;
				//性别
				var sex = $("input:radio[name='sex']:checked").val() * 1;
				data.harvestWorkerVo.sex = sex;
				//手机号码
				var phone = $api.val(domMap.$phone);
				
				data.harvestWorkerVo.phone = phone;
				//照片id
				var picId = $('#headshot img').attr('data-id');
				data.harvestWorkerVo.basFile.id = picId;
				
				//记工单列表
				//console.log($('#addList ul').length)
				$('#addList ul').each(function(i, el) {
					if($(this).attr("hmc")==1){
						return true;
					}
					var listObj = {
						harvestWorkRecordDetailsVoList : []
					};
					var date = $(el).find('.date').val();
					listObj.recordDate = date+':00';
					var harNumber = $(el).find('.harNumber').val();
					listObj.standardNumber = harNumber;
					var molecular = $(el).find('.molecular').val();
					listObj.numerator = molecular;
					var denominator = $(el).find('.denominator').val();
					listObj.denominator = denominator;
					$(el).find('.addLine').each(function(j, ele) {
						var harvestWorkRecordDetail = {};
						var grade = $(ele).find('.grade').val();
						harvestWorkRecordDetail.grade = grade;
						var gradeNum = $(ele).find('.gradeNum').val();
						harvestWorkRecordDetail.harvestNumber = gradeNum;
						var unit = $(ele).find('.unit').attr('data-id');
						harvestWorkRecordDetail.unit = unit;
						listObj.harvestWorkRecordDetailsVoList.push(harvestWorkRecordDetail);
					})
					data.harvestWorkRecordList.push(listObj);
				})
				//alert(JSON.stringify(data))
				var validFields = [
					      {field: 'farmId',    name: '基地' , rule: 'required'},
					      {field: 'landId',    name: '地块' , rule: 'required'},
					      {field: 'catalogId', name: '品名' , rule: 'required'},
					      {field: 'categoryId',name: '品种' , rule: 'required'},
					      {field: 'harvestWorkerVo.name',      name: '姓名' , rule: 'required'},
					      {field: 'harvestWorkerVo.phone',     name: '手机号', rule: 'required|mobile' },
					//    {field: 'standardNumber', name: '规格数量',rule: 'required|digits2' },
					//    {field: 'numerator', name: '规格数量分子' ,rule: 'required'},
					//    {field: 'grade', name: '等级' ,rule: 'required'},
					//    {field: 'harvestNumber', name: '等级数量' ,rule: 'required|digits2'},
              ]
    
			    var rules = (function(validFields){
			      var ret = {}
			      validFields.forEach(function(it){
			        ret[it.field] = it.rule
			      })
			      return ret
			    })(validFields);
			    var attributeNames = (function(validFields){
			      var ret = {}
			      validFields.forEach(function(it){
			        ret[it.field] = it.name 
			      })
			      return ret
			    })(validFields);
			    Validator.register('mobile', function(value, requirement, attribute) {
			        return (value+'').match(/^1[0-9]{10}$/);
			    }, '请输入正确的手机号码.');
			    Validator.register('digits2', function(value, requirement, attribute) {
			        return (value+'').match(/^\d+(\.\d{1,2})?$/);
			    }, ':attribute应为数字，并允许有两位小数.');
			    var messages = Validator.getMessages('en');
			    messages.required = ':attribute不能为空.';
			    Validator.setMessages('en', messages);
			    var valid = new Validator(data, rules);
			    valid.setAttributeNames(attributeNames);
			    if (!valid.passes()) {
			        for (var i = 0; i < validFields.length; i++) {
			          var vf =  validFields[i].field;
			          if (valid.errors.has(vf)) {
			            api.alert({msg: valid.errors.first(vf) })
			            break
			          }
			        }
			        return
			    }
			 if(data.harvestWorkRecordList){
			      	for(var i=0;i<data.harvestWorkRecordList.length;i++){
			      	  var obj = data.harvestWorkRecordList[i];
								if(obj.standardNumber==''){
								  api.alert({
								      msg: '规格数量不能为空' 
								  })
								   return;		
								}else{
									if(!obj.standardNumber.match(/^\d+(\.\d{1,2})?$/)){
										api.alert({
								      	msg: '规格数量应为数字，并允许有两位小数.' 
									})
									   return;	
									}
								}
								if(obj.numerator==''){
								  api.alert({
								      msg: '请选择规格数量单位' 
								  })
								   return;		
								}
								
								for(var w=0;w<obj.harvestWorkRecordDetailsVoList.length;w++){
								var det = obj.harvestWorkRecordDetailsVoList[w];
								 if(det.grade==''){
								  api.alert({
								      msg: '等级不能为空' 
								  })
								  return;	
								}
								if(det.harvestNumber==''){
								  api.alert({
								      msg: '等级数量不能为空' 
								  })	
								   return;	
								}
							}
			            }
			       }
			      // console.log(JSON.stringify(data))
		          api.confirm({
		               title: '提示',
		               msg: '信息保存后就不能修改啦~您确认吗？',
		               buttons: ['取消', '确定']
		             }, function(ret, err) {
		               var index = ret.buttonIndex;
		               if(index==2){
		                //$('#save').attr('disabled','disabled');
		                //console.log(JSON.stringify(data))
						pds.ajaxSubmit({
							url : "app/recordworkorder/query_worker_name?name=" + name + '&sex=' + sex + '&phone=' + phone,
							success : function(res) {
								//$('#save').removeAttr('disabled','disabled');
								//alert(JSON.stringify(res))
								if (res.status == 'ok') {
									var result = res.data;
									if (true) {
										data.id=mainId;
										data.harvestWorkerVo.id=workerId;
										pds.ajaxSubmit({
										url : "app/recordworkorder/insert_work_order_sheet",
										data : {
											'data' : JSON.stringify(data)
										},
										success : function(res) {
											if (res.status == 'ok') {
												hasSave = 1;
											  //alert(JSON.stringify(res))
											  var data = res.data;
											  api.alert({msg:'保存成功！'})
											  orderStatusFlag = data.orderStatus;
											  needSubmit=false;
											  oldImage=$('#headshot img').prop('data-id');
											  if($('#headshot img')){ 
											     $('#headshot img').click(function(){preview()});
											  }
											 
											  //标记当前界面所有记工单为已保存
											  mainId = data.id;
											  workerId = data.harvestWorkerVo.id;
											  basMes();
											  $('#farmName').attr('oldval',$('#farmName').val());
					           		          $('#landName').attr('oldval',$('#landName').val());
					           		          $('#catName').attr('oldval',$('#catName').val());
					           			      $('#categoryName').attr('oldval',$('#categoryName').val());
					           			      $('#name').attr('readonly','true');
					           			      $('#name').attr('oldval',$('#name').val());
					           			      $('#phone').attr('readonly','true');
					           			      $('#phone').attr('oldval',$('#phone').val());
					           			      $("input:radio[name='sex']").attr('disabled','disabled');
					           			      $("input:radio[name='work']").attr('disabled','disabled');
					           			      $('#delPic').hide();
					           			      saved = true;
											$('.mark').each(function(){
											  if($(this).attr("hmc")==1){
											   return true;
					           			       }
											  $(this).attr("hmc",1);
											 // $(this).find('.plus').css('display','none');
											  $(this).find('.right').hide();
						           			  $(this).find('.molecular').attr('disabled','disabled');
						           			  $(this).find('.molecular').css('border','none');
						           			  $(this).find('.denominator').attr('disabled','disabled');
						           			  $(this).find('.denominator').css('border','none');
						           			  $(this).find('.grade').attr('disabled','disabled');
											  $(this).find('.grade').css('border','none');
						           			  $(this).find('.gradeNum').attr('disabled','disabled');
						           			  $(this).find('.gradeNum').css({'border':'none'});
						           			  $(this).find('.harNumber').attr('disabled','disabled');
						           			  $(this).find('.harNumber').css('border','none');
						           			  $(this).find('.date').css('border','none');
						           			  $(this).find('.aui-icon-down').hide();
						           			  var num1=$(this).find('.harNumber').val();
						           			  var mole=$(this).find('.molecular').find('option:selected').text();
						           			  var deno=$(this).find('.denominator').find('option:selected').text();
						           			  var crop;//拼接
						           			  if(deno=="请选择"){
						           			     crop=num1+mole;
						           			  }else{
						           			     crop=num1+mole+'/'+deno;
						           			  }
						           			  $(this).find('.line1 .aui-list-item-label').css('width','80%');
						           			  $(this).find('.line1 .aui-list-item-input').css('width','100%');
						           			  $(this).find('.line2 .aui-list-item-input').remove();
						           			  $(this).find('.line2 .aui-list-item-label').css('width','80%');
						           			  $(this).find('.line2').append('<div class="aui-list-item-input"style="width:100%;">'+crop+'</div>');
						           			  //alert($(this).find('.line3').html())
						           			 $(this).find('.line3').each(function(el){
						           			    var grade1=$(this).find('.grade').find('option:selected').text();
						           			    var gradeNum1=$(this).find('.gradeNum').val();
						           			    //console.log(gradeNum1)
//						           			    if(gradeNum1<0){
//						           			      $('').css('color','red');
//						           			    }
						           			    var unit1=$(this).find('.unit').val();
						           			    //alert(grade1)
						           			    $(this).html('<div class="aui-list-item-label" style="width:80%;white-space: normal;line-height: 0.8rem;">'+grade1+'</div><div class="aui-list-item-input "style="width:100%;'+(gradeNum1<0?'color:red;':'')+'" >'+gradeNum1+unit1+'</div>');
						           			 })
													})
												}
											}
										})
									} else {
										api.alert({
											msg : "已经存在该工人信息"
										});
									}
								}
				        	}
			        	 })
                      }
                  });
			   }
			
			configMoule = function() {//可以有参数
			}
			initModule = function(farmId,landId,catalogId,categoryId) {//可以有参数
				setDomMap();
				onBtnfarm(farmId,landId,catalogId,categoryId);
//				onBtnland(farmId,landId)
			}
			//-------end 操作方法-----
			//return 公用函数
			return {
				configMoule : configMoule,
				initModule : initModule,
				onBtnSave:onBtnSave
			}
		})();
	</script>
</html>
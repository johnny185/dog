var pageParam = null;
apiready = function() {
	pageParam = api.pageParam;
	//alert(JSON.stringify(pageParam));
	// 根据基地ID获取基地信息
	pds.ajaxSubmit({
		url : "app/farm/getFarmData",
		data : {
			"farmId" : pageParam.farmId
		}, //
		success : function(e) {
			if (e.status == 'error') {
				api.alert({
					msg : e.message
				});
			} else {
				var farm = e.data;
				$('#farmName').val(farm.farmName);
				$('#farmArea').val(farm.farmArea);
				$('#farmUserName').val(farm.farmUserName);
				$('#farmMobile').val(farm.farmMobile);
				$('#farmProvinceCode').val(farm.farmProvinceCode);
				$('#farmCityCode').val(farm.farmCityCode);
				$('#farmCountyCode').val(farm.farmCountyCode);
				$('#farmAddress').val(farm.farmAddress);
				$('#limitYears').val(farm.limitYears);
				$('#farmStorageArea').val(farm.farmStorageArea);
				$('#farmRemark').val(farm.farmRemark);
				$('#address').val(farm.address);
				farmOfficeId = farm.farmOfficeId;
			}
		},
		error : function(e) {
			api.alert({
				msg : "服务器错误，请联系管理员!"
			});
		}
	});
}
// 得到json对象
function getJsonObj() {
	var farm = {};
	farm.farmName = $('#farmName').val();
	farm.farmArea = $('#farmArea').val();
	farm.farmUserName = $('#farmUserName').val();
	farm.farmMobile = $('#farmMobile').val();
	farm.farmProvinceCode = $('#farmProvinceCode').val();
	farm.farmCityCode = $('#farmCityCode').val();
	farm.farmCountyCode = $('#farmCountyCode').val();
	farm.farmAddress = $('#farmAddress').val();
	farm.limitYears = $('#limitYears').val();
	farm.farmStorageArea = $('#farmStorageArea').val();
	farm.farmRemark = $('#farmRemark').val();
	farm.address = $('#address').val();
	farm.id = pageParam.farmId;
	farm.farmOfficeId = farmOfficeId;
	return farm;
}

function updateFarmInfo() {
	// 提交按钮失效,避免重复提交
	//$("#submitId").attr("disabled", "disabled");
	// 得到json对象
	var farm = getJsonObj();
	// 校验数据
	if (!checkFarmInfo(farm)) {
		// 让提交按钮恢复
		//$('#submitId').removeAttr("disabled");
		return;
	}
	pds.ajaxSubmit({
		url : "app/farm/saveFarmData",
		data : {
			"data" : JSON.stringify(farm)
		},
		success : function(e) {
			// 让提交按钮恢复
			//$('#submitId').removeAttr("disabled");
			if (e.status == 'error') {
				api.alert({
					msg : e.message
				});
			} else {
				api.alert({
					msg : "修改成功"
				});
			}
		},
		error : function(e) {
			api.alert({
				msg : "服务器错误，请联系管理员!"
			});
			// 让提交按钮恢复
			//$('#submitId').removeAttr("disabled");
		}
	});
}

// 进入地块详情
function goLand() {
	api.openWin({
		name : 'parcel_information',
		url : '../land/parcel_information.html',
		pageParam : {
			"farmId" : pageParam.farmId
		}
	});
}

// 进入植保详情
function goCropProtection() {
	api.openWin({
		name : 'crop_message',
		url : '../mysetting/mysettings/crop/crop_message.html',
		pageParam : {
			"farmId" : pageParam.farmId
		}
	});
}

//返回
function back() {
	api.closeWin({
	});
	// 执行win_home窗口里的exec()方法
	api.execScript({
		name : pageParam.sourceName,
		script : "exec();"
	});
}

//跳转到省市区县选择页面
function selectAddress() {
	api.openWin({
		name : 'adress_province',
		url : '../mysetting/mysettings/address/address_province.html',
		reload : true,
		animation : {
			type : "movein", //动画类型（详见动画类型常量）
			subType : "from_right", //动画子类型（详见动画子类型常量）
			duration : 300 //动画过渡时间，默认300毫秒
		},
		// name指定的是回跳的窗口名，fun指定的是回调用的方法名
		pageParam : {
			"name" : "farm_detail",
			"fun" : "getAddressCode"
		}
	});
}

// 获取选择省市的code码
function getAddressCode(addressName, proCode, cityCode, countryCode) {
	$("#address").val(addressName);
	$("#farmProvinceCode").val(proCode);
	$("#farmCityCode").val(cityCode);
	$("#farmCountyCode").val(countryCode);
}

// 手机正则
var phoneReg = /^1[3|4|5|7|8][0-9]{9}$/;
// 数字正则
var numReg = /^(0\.|[1-9]+\.{0,1})\d*$/;
// 校验数据
function checkFarmInfo(farm) {
	if (farm.farmName == null || farm.farmName.length <= 0 || farm.farmName.replace(/\ +/g, "").length <= 0) {
		api.alert({
			msg : "基地名称不能为空"
		});
		return false;
	}
	if (farm.farmArea == null || farm.farmArea.length <= 0 || farm.farmArea.replace(/\ +/g, "").length <= 0) {
		api.alert({
			msg : "基地面积不能为空"
		});
		return false;
	} else {
		if (!numReg.test(farm.farmArea)) {
			api.alert({
				msg : "请填写正确的数据"
			});
		} else {
			if (farm.farmArea <= 0) {
				api.alert({
					msg : "基地面积必须大于0"
				});
				return false;
			}
		}
	}

	if (farm.farmUserName == null || farm.farmUserName.length <= 0 || farm.farmUserName.replace(/\ +/g, "").length <= 0) {
		api.alert({
			msg : "负责人不能为空"
		});
		return false;
	}
	if (farm.farmMobile == null || farm.farmMobile.length <= 0 || farm.farmMobile.replace(/\ +/g, "").length <= 0) {
		api.alert({
			msg : "手机号不能为空"
		});
		return false;
	} else {
		if (!phoneReg.test(farm.farmMobile)) {
			api.alert({
				msg : "手机号格式错误"
			});
			return false;
		}
	}
	if (farm.farmProvinceCode == null || farm.farmProvinceCode.length <= 0) {
		api.alert({
			msg : "请选择基地地址"
		});
		return false;
	}
	if (farm.farmAddress == null || farm.farmAddress.length <= 0 || farm.farmAddress.replace(/\ +/g, "").length <= 0) {
		api.alert({
			msg : "基地详细地址不能为空"
		});
		return false;
	}
	if (farm.limitYears != null && farm.limitYears.length > 0) {
		if (!numReg.test(farm.limitYears)) {
			api.alert({
				msg : "请填写正确的数据"
			});
			return false;
		} else {
			if (farm.limitYears <= 0) {
				api.alert({
					msg : "流转年限必须大于0"
				});
				return false;
			}
		}
	}
	if (farm.farmStorageArea != null && farm.farmStorageArea.length > 0) {
		if (!numReg.test(farm.farmStorageArea)) {
			api.alert({
				msg : "请填写正确的数据"
			});
			return false;
		} else {
			if (farm.farmStorageArea <= 0) {
				api.alert({
					msg : "冷库面积必须大于0"
				});
				return false;
			}

		}
	}
	if (farm.address == null || farm.address.length <= 0 || farm.address.replace(/\ +/g, "").length <= 0) {
		api.alert({
			msg : "基地地址不能为空"
		});
		return false;
	}
	return true;
}
<!DOCTYPE html>
<html>
<head>
	<title>运输单-待抽检</title>
	<meta http-equiv="Content-type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no" />
    <link rel="stylesheet" type="text/css" href="../../../css/api.css"/>
    <link rel="stylesheet" type="text/css" href="../../../css/common.css"/>
    <link rel="stylesheet" type="text/css" href="../../../css/harvest-style.css">
</head>
<body>
<div class="container"  style="margin-top:0px;">
	<div class="full-main">
		<div class="fixed-banner2">	
			<div id = "sub-banner-id" class='sub-banner'>
				<ul>
					<label class="col-4">
						<span tapmode="" id = 'sub-banner-1' class='harvestTransportOrderClass selected' flag="SAMPLING">待抽检</span>
					</label>

					<label class="col-4">
						<span tapmode="" id = 'sub-banner-2' class='harvestTransportOrderClass border-right' flag="WAITSTORAGE">待入库</span>
					</label>

					<label class="col-4">
						<span tapmode="" id = 'sub-banner-3' class='harvestTransportOrderClass' flag="STORAGE">已入库</span>
					</label>
				</ul>
			</div>
		</div>
	</div>
	<div class="full-main">
		<div class="sub-sub-container2">
		<!-- 下拉刷新 -->
			<div id="wrapper">
				<div id="scroller">
					<!--<div id="pullDown">
						 <span class="pullDownIcon"></span> 
						<div class="pullDownLabel">下拉刷新...</div>
					</div>-->
					<ul id="harvestTransportListContainer">
					</ul>
					<!--<div id="pullUp">
						 <span class="pullUpIcon"></span> 
						<div class="pullUpLabel">上拉加载更多...</div>
					</div>-->
					<span id="noDataTips" style="">没有数据了...</span>
				</div>
			</div>	
		</div>
	</div>
</div>
<script type="text/javascript" src="../../../script/common/api.js"></script>
<script type="text/javascript" src="../../../script/common/zepto.min.js"></script>
<script type="text/javascript" src="../../../script/common/doT.min.js"></script>
<script type="text/javascript" src="../../../script/common/pds.ajax.js"></script>
<script type="text/javascript" src="../../../script/scroll/build/iscroll-loading.js"></script>
<script type="text/javascript" src="../../../script/common/pds.iscroll.min.js"></script>
<script  id="harvestTransportOrderTmp" type="text/x-dot-template">
{{~it :value:index }}
<li>
	<table class="tablestyle0">
		<tr class="tablestyle0-tr" tapmode="" onclick="toharvestTransportDetails({{= value.id }})">
			<td class="col-sm-2">
				<div><img class = "table-md-image" src="../../../image/transport.png"></div>
			</td>
			<td class="col-7">
				<a href="javascript:void(0);">
					<table class='tablestyle0-transport'>
						<tr><th>运输单号: </th><td>{{= value.code }}</td></tr>
						<tr><th>采收单号: </th><td>{{= value.harvestWorkOrderCode }}</td></tr>
						<tr><th>装车负责人:</th><td>{{= value.userName}}</td></tr>
						<tr><th>要求开始时间: </th><td>{{= value.createDate }}</td></tr>
					</table>
				</a>
			</td>
			<td class="col-1">
				{{? value.orderStatus == "SAMPLING"}}
				<div class=""><img class = "table-xs-image" src="../../../image/notification.png"></div>
				{{?}}
				<div><img class = "table-sm-image" src="../../../image/next-button.png"></div>
			</td>
		</tr>
	</table>
</li>
{{~}}
</script>
<script type="text/javascript">	
var userId = null;
var pageNum = 1;
var pageSize = 20;
var status = null;
var total = null;

var transportOrderStatus = null;
apiready = function(){
	transportOrderStatus = {};
	transportOrderStatus["SAMPLING"] = "SAMPLING";/* 待抽检  */
	transportOrderStatus["WAITSTORAGE"]  = "WAITSTORAGE";   /* 待入库  */
	transportOrderStatus["STORAGE"]  = "STORAGE";   /* 已入库 */

    status = transportOrderStatus["SAMPLING"];
	userId = $api.getStorage("userId");
    
    getDataList(userId,status,1);
	    /* 滑动至底部加载更多  */        
    api.addEventListener({name: 'scrolltobottom'}, function(ret, err){
    	getDataList(userId,status,0);      
    });       
	/* 添加下拉刷新  */
	api.setRefreshHeaderInfo({
	    visible: true,
	    loadingImg: '../../../image/refreshing_image_01.png',
	    bgColor: '#ccc',
	    textColor: '#fff',
	    showTime: true
	}, function(ret, err){
	    getDataList(userId,status,1);
	    api.refreshHeaderLoadDone();
    });
    
//	pds.initIscroll({
//		userId    : userId,
//		statusObj :{"orderStatus":transportOrderStatus["SAMPLING"]},
//		listUrl   : "app/harvesttransportorder/getHarvestTransportOrderList",
//		container :"#harvestTransportListContainer",
//		rowTemplete : "#harvestTransportOrderTmp"
//	});
	
//  document.addEventListener('touchmove', function (e) { e.preventDefault(); }, false);
//	document.addEventListener('DOMContentLoaded', pds.loaded(), false); 
}

/* 加载列表   */
function getDataList(loginId,status,flag){
	if(flag*1 == 1){
		pageNum = 1;
		$("#harvestTransportListContainer").html("");
	}
	var params = {"userId":userId,"orderStatus":status,"pageNum":pageNum,"pageSize":pageSize};
	pds.ajaxSubmit({
		url:"app/harvesttransportorder/getHarvestTransportOrderList",
		data:{"data":JSON.stringify(params)},
		success:function(e){
			var dataInter = e.data;
			total = e.total;
			if(dataInter && dataInter.length>0){
				pageNum++;
				var interText = doT.template($("#harvestTransportOrderTmp").text());
				if(flag*1 == 1){
					$("#harvestTransportListContainer").html(interText(dataInter));
				}else{
					$("#harvestTransportListContainer").append(interText(dataInter));
				}
				$("#noDataTips").hide();
			}else{
				$("#noDataTips").show();
			}
		},
		error:function(e){
			api.alert({msg:"服务器错误，请联系管理员!"});
		}
	});
}

/* 跳转至采收运输单详情页面  */
function toharvestTransportDetails(transportOrderId){
		api.openWin({
        name: "harvest_transport_details",
        url:  "./details/harvest_transport_details.html",
        pageParam: {"transportOrderId":transportOrderId,"status":status},
        slidBackEnabled:false,
        animation:{
            type:"movein",                //动画类型（详见动画类型常量）
            subType:"from_right",       //动画子类型（详见动画子类型常量）
            duration:300                //动画过渡时间，默认300毫秒
        }
	});
}

/* 菜单点击事件  */
$(".harvestTransportOrderClass").off("click");
$(".harvestTransportOrderClass").on("click",function(){
	var that = $(this);
	$(".harvestTransportOrderClass").removeClass("selected");
	that.addClass("selected");
	status = that.attr("flag");
	getDataList(userId,status,1);
});
</script>
</body>
</html>
<!DOCTYPE html>
<html>
	<head>
		<meta charset="UTF-8">
		<meta name="viewport" content="maximum-scale=1.0,minimum-scale=1.0,user-scalable=0,width=device-width,initial-scale=1.0"/>
		<title>云API</title>
		<link rel="stylesheet" type="text/css" href="../css/api.css"/>
		<link rel="stylesheet" type="text/css" href="../css/style.css"/>
		
		<script type="text/javascript" src="../script/jquery.min.js"></script>
	    <script type="text/javascript" src="../script/kendo.core.min.js"></script>
	    <script type="text/javascript" src="../script/kendo.data.min.js"></script>
	    <script type="text/javascript" src="../script/kendo.binder.min.js"></script>
	    <script type="text/javascript" src="../script/pds.ajax.js"></script>
        <script type="text/javascript" src="../script/api.js"></script>
	    <script type="text/javascript" src="../script/availdate-v1.0.2.js"></script>
	    <script type="text/javascript" src="../script/getLoacat.js"></script>
		<style>
			html {
			    font-family: "Microsoft YaHei";
			}
			/*基本信息框*/
			.information label {
				height: 32px;
				padding-left:10px;
				color: #333;
				background-color: #f5f5f5;
				display: -webkit-box;
				display: -webkit-flex;
				display: flex;
				font-size: 16px;
				vertical-align: middle;
				-webkit-box-align: center;
				-webkit-align-items: center;
				align-items: center;
			
			}
			/*设置背景颜色的div*/
			#module {
				background-color: #E5E5E5;
				height: 250%;
				display: -webkit-box;
				-webkit-box-orient: vertical;
				line-height: 50px;
			}
			/*地块编号*/
			.code label {
				font-size: 14px;
				color: #0F0F0F;
			}
			/*天气情况*/
			.wether label {
				font-size: 14px;
				color: #000000;
			}
			.wether input {
				background-color: #FFFFFF;
				background-size: 35px;
			}
			/*气温*/
			.temperature label {
				font-size: 14px;
				color: #0F0F0F;
			}
			.temperature input {
				background-color: #FFFFFF;
				background-size: 35px;
			}
			/*土壤湿度*/
			.moisture label {
				font-size: 14px;
				color: #0F0F0F;
			}
			.moisture input {
				background-color: #FFFFFF;
				background-size: 35px;
			}
			/*----------------------------------------------------------------*/
			/*作物情况框*/
			.situation label {
				height: 32px;
				padding-left:10px;
				color: #333;
				background-color: #f5f5f5;
				display: -webkit-box;
				display: -webkit-flex;
				display: flex;
				font-size: 16px;
				vertical-align: middle;
				-webkit-box-align: center;
				-webkit-align-items: center;
				align-items: center;
			
			}
			/*株高*/
			.height label {
				font-size: 14px;
				color: #0F0F0F;
			}
			.height input {
				background-color: #FFFFFF;
				background-size: 35px;
			}
			/*叶片数量*/
			.numleaf label {
				font-size: 14px;
				color: #0F0F0F;
			}
			.numleaf input {
				background-color: #FFFFFF;
				background-size: 35px;
			}
			/*叶片直径*/
			.blade label {
				font-size: 14px;
				color: #0F0F0F;
			}
			.blade input {
				background-color: #FFFFFF;
				background-size: 35px;
			}
			/*叶片茎粗*/
			.thick label {
				font-size: 14px;
				color: #0F0F0F;
			}
			.thick input {
				background-color: #FFFFFF;
				background-size: 35px;
			}
			/*病害的文本框*/
			.disease label {
				font-size: 14px;
				color: #0F0F0F;
			}
			#div1 {
				height: 40px;
				background-color: #FFFFFF;
				background-size: 35px;
			}
			/*虫害*/
			.pests label {
				font-size: 14px;
				color: #0F0F0F;
			}
			#div2 {
				height: 40px;
				background-color: #FFFFFF;
				background-size: 35px;
			}
			/*草害*/
			.weeds label {
				font-size: 14px;
				color: #0F0F0F;
			}
			#div3 {
				height: 40px;
				background-color: #FFFFFF;
				background-size: 35px;
			}
			/*其他说明*/
			.instructions label {
				font-size: 14px;
				color: #0F0F0F;
			}
			.instructions input {
				height: 40px;
				background-color: #FFFFFF;
				background-size: 35px;
			}
			/*---------------------------------------------------------------------------*/
			/*照片上传框*/
			.photos label {
				height: 32px;
				padding-left:10px;
				color: #333;
				background-color: #f5f5f5;
				display: -webkit-box;
				display: -webkit-flex;
				display: flex;
				font-size: 16px;
				vertical-align: middle;
				-webkit-box-align: center;
				-webkit-align-items: center;
				 align-items: center;
			
			}
			/*叶片正面照*/
			.positive input {
				background-size: 35px;
			}
			/*叶片反面照*/
			.reverse input {
				background-size: 35px;
			}
			/*生长点照*/
			.growing input {
				background-size: 35px;
			}
			/*作物全景照*/
			.panorama input {
				background-size: 35px;
			}
			/*区域全景照*/
			.regional input {
				background-size: 35px;
			}
			/*注意事项*/
			.attention label {
				font-size: 14px;
				color: #0F0F0F;
			}
			.attention input {
				height: 60px;
				background-color: #FFFFFF;
				background-size: 35px;
			}
			/*--------------------------------------------------------------------*/
			.btn {
				margin: 3px 10px;
			}
			.btn {
				background: #00F5FF;
				height: 40px;
				text-align: center;
				line-height: 40px;
				font-size: 20px;
				margin-top: 20px;
				border-radius: 5px;
			}
			.btn button {
				color: #FFFFFF;
			}
			
			    #gallery {
			background-color: #FFFFFF;
			padding: 10px;
			width: 100%;
			}
			#gallery ul { list-style: none; }
			#gallery ul li { display: inline; }
			#gallery ul img {
				border: 5px solid #3e3e3e;
				border-width: 5px 5px 20px;
			}
			#gallery ul a:hover img {
				border: 5px solid #fff;
				border-width: 5px 5px 20px;
				color: #fff;
			}
			#gallery ul a:hover { color: #fff; }
			.areas {padding-left:10px; padding-right:10px;}
			.areas > div {
				margin-top:10px;
				margin-bottom:10px;
			}
			input,textarea {
				border:1px solid #E5E5E5;
			}
			input {
				height:30px;
			}
			textarea {
				width:100%;
				min-height:80px;
				margin-top:8px;
				box-sizing: border-box;
			}
			.areas > div label {
				color:#c4c4c4;
				width:70px;
				text-align:right;
			}
			.btn-submit {
				width:80%;
				height:auto;
				line-height:32px;
				text-align:center;
				background-color:#66BB6A;
				color:#fff;
				font-size:16px;
				font-weight:bold;
				border-radius:4px;
				margin: 0px auto 50px;
				padding-top: 6px;
				padding-bottom: 6px; 
			}
			.icon-plus {
				position:relative;
				display:inline-block;
				width:14px;
				height:2px;
				background-color:#00B841;
				top:-10px;
			}
			.icon-plus:after {
				display:inline-block;
				position:absolute;
				left: 50%;
				top: -6px;
				margin-left: -1px;
				content: "";
				height:14px;
				width:2px;
				background-color:#00B841;
			}
			.imgbox {
				display:table-cell;
				width:100px;
				height:100px;
				text-align: center;
				vertical-align:middle;
				background-color: #fbfbfb;
				border: 1px solid #ddd;
				/* Firefox */
				/*display:-moz-box;
				-moz-box-pack:center;
				-moz-box-align:center;*/
				
				/* Safari, Chrome, and Opera */
				/*display:-webkit-box;
				-webkit-box-pack:center;
				-webkit-box-align:center;*/
				
				/* W3C */
				/*display:box;
				box-pack:center;
				box-align:center;*/	
			}
			.imgbox2 {
				position:relative;
				display:table-cell;
				width:100%;
				height:auto;
				text-align: center;
				vertical-align:middle;
				border: 1px solid #ddd;
			}
			.imgIcon-del {
				position:absolute;
				right:5px;
				top:5px;
				display:inline-block;
				padding-left:10px;
				padding-right:10px;
				line-height:30px;
				color:#fff;
				background-color:rgba(0,0,0,.7);
				font-style:normal;
				-moz-border-radius:4px;
				-webkit-border-radius:4px;
				border-radius:4px;
			}
			.imgbox p {
				font-size:14px;
				color:#ddd;
				height:20px;
				line-height:20px;
				clear:both;
			}
			.imgbox img,
			.imgbox2 img {
				max-width:100%;
				max-height:100%;
				display:block;
			}
			.img-name {
				font-size:14px;
				font-weight:normal;
				line-height:32px;
				color:#c4c4c4;
			}
			.img-list {
				margin-left:-6px;
				margin-right:-6px;
			}
			.img-list li {
				display:inline-block;
				padding-left:6px;
				padding-right:6px;
				margin-bottom:10px;
				overflow:hidden;
			}
			.img-area {
				margin-top:10px;
				margin-bottom:10px;
			}
		</style>
	</head>
	<body>
		<!--基本信息框-->
		<div class="information">
			<div class="basic">
				<label>基本信息</label>
			</div>
		</div>
		<!--设置背景颜色的div-->
		<div id="bigdiv">
			<div class="areas">
				<!--地块编号-->
				<div class="code">
					<label>地块名称:</label>
					<input id="landname"  disabled= "true"/>
				</div>
				<div class="wether">
					<label>天气情况:</label>
					<!-- <input id="weather"/> -->
					<select id="weather">
						 <option value="晴">晴</option>
						 <option value="阴">阴</option>
						 <option value="雨">雨</option>
						 <option value="雪">雪</option> 
					</select>
				</div>
				
				<div class="temperature">
					<label>气温:</label>
					<input id="temperature" type="number" onkeyup='this.value=this.value.replace(/\D/gi,"")'/> ℃
				</div>
				<!--土壤湿度-->
				<div class="moisture">
					 <label>土壤湿度:</label> 
			          <input id="moisture" type="number"/> % 
				</div>
				<div class="temperature">
					<label>土壤温度:</label>
					<input id="soiltemp" type="number" onkeyup='this.value=this.value.replace(/\D/gi,"")'/> ℃ 
				</div>
			</div>
			<!------------------------------------------------------------->
			<!--作物情况框-->
			<div class="situation">
				<div class="crops ">
					<label><b>作物情况</b></label>
				</div>
			</div>
			<div class="areas">
				<!--株高-->
				<div class="height">
					<label>株高：</label>
					<input type="number" id="cropHeight" onkeyup='this.value=this.value.replace(/\D/gi,"")'/> 厘米
				</div>
				<!--叶片数量-->
				<div class="numleaf">
					<label>叶片数量:</label>
					<input id="leaveNum" type="number" onkeyup='this.value=this.value.replace(/\D/gi,"")'/> 片
				</div>
				<!--叶片直径-->
				<div class="blade">
					<label>茎粗:</label>
					<input id="leaveDiameter" type="number" onkeyup='this.value=this.value.replace(/\D/gi,"")'/> 厘米
				</div>
				
				<!--病害-->
				<div class="disease">
					
					<label>病害:</label>
					<!-- 有 &nbsp;&nbsp;&nbsp;<input name="Fruit" type="radio" value="1" />&nbsp;&nbsp;
					无 &nbsp;&nbsp;&nbsp;<input name="Fruit" type="radio" value="2" /><br/>
					<label>备注:</label> -->
					<input id="diseasesFlag"/>
				</div>
				<!--虫害-->
				<div class="pests">
					<label>虫害:</label>
					<input id="pestsFlag"/>
				</div>
				<!--草害-->
				<div class="weeds">
					<label>草害:</label>
					<input id="weedsFlag"/>
				</div>
				<!--其他说明-->
				<div class="instructions">
					<div>其它说明:</div>
					<textarea id="remarks"></textarea>
				</div>
			</div>
			<!-------------------------------------------------------------------->
			<!--照片上传框-->
			<div class="photos">
				<div class="update ">
					<label><b>照片详情</b></label>
				</div>
			</div>
			<div class="areas">
				<!--照片-->  
				<div class="img-area">
					<h3 class="img-name">叶片正面照</h3>
					<ul class="img-list">
						<li flag="10" bledflag="1" onclick="imageUpload(this)">
							<div class="imgbox">
								<i class="icon-plus"></i>
								<p>图片上传</p>
							</div>
						</li>
					</ul>
				</div>
				<div class="img-area">
					<h3 class="img-name">叶片反面照</h3>
				<ul class="img-list">
						<li flag="11" bledflag="1" onclick="imageUpload(this)">
							<div class="imgbox">
								<i class="icon-plus"></i>
								<p>图片上传</p>
							</div>
						</li>
				</ul>	
				</div>
				<div class="img-area">
					<h3 class="img-name">生长点照</h3>
				   <ul class="img-list">
						<li flag="12" bledflag="1" onclick="imageUpload(this)">
							<div class="imgbox">
								<i class="icon-plus"></i>
								<p>图片上传</p>
							</div>
						</li>
					</ul>	
				</div>
				<div class="img-area">
					<h3 class="img-name">作物全景照</h3>
				<ul class="img-list">
						<li flag="13" bledflag="1" onclick="imageUpload(this)">
							<div class="imgbox">
								<i class="icon-plus"></i>
								<p>图片上传</p>
							</div>
						</li>
					</ul>	
				</div>
				<div class="img-area">
					<h3 class="img-name">区域全景照</h3>
				<ul class="img-list">
						<li flag="14" bledflag="1" onclick="imageUpload(this)">
							<div class="imgbox">
								<i class="icon-plus"></i>
								<p>图片上传</p>
							</div>
						</li>
					</ul>	
				</div>
				<!--注意事项-->
				<div class="attention">
					<div>注意事项 :</div>
					<textarea id="cropRemarks" ></textarea>
				</div>
			</div>
			<div class="btn-submit"  id="submit" tapmode="" disabledflag="1" onclick="save(this)">提交</div>
			<div class="btn-submit"  id="psubmit" tapmode="" disabledflag="1" onclick="closeWin()">返回</div>
			<!-- -->
		</div>



	<script type="text/javascript">
	
	var userId = null;
	var TaskId = null;
	
	var AppFarmlandDetailData = null;
	var picUpload = false;
	var map = null;
	var imageMap = {};
	apiready = function() {
	   var db = pds.getDb();
	   document.getElementById("landname").value =api.pageParam.landname
	   TaskId = api.pageParam.id;
	   userId =  $api.getStorage("userId");
	   AppFarmlandDetailData = {};
	   AppFarmlandDetailData.appFarmlandPic = [];
	   map = pds.getMap();
	   getlocation();
	}

	/*返回*/

	function closeWin() {
		api.closeWin();
	}

	$('#psubmit').clicl(function(){
		pds.foward("${ctx }/html/frm_field_taskListMap");

	})

	  function getlocation(){
          pds.ajaxSubmit({
				 url:"app/farmland/find/pushtype",
				 data:{'userId':userId},
				 success:function(e){
				      if(e.data==1){
				        pds.getLocat();
				      }
				},
				error:function(e){
					alert("服务器异常，请联系管理员!!!");
				}
			});
     }
	
	
	//点击上传照片的方法
	function imageUpload(dom){
	
	    var Flag = dom.getAttribute("flag");
	    
		api.getPicture({
		    sourceType: 'camera',//从照相机获取
		    encodingType: 'jpg',//格式
		    mediaValue: 'pic',//视频格式
		    destinationType: 'url',//
		    allowEdit: true,
		    quality: 10,
		    saveToPhotoAlbum: false
		}, function(re, err){ 
		
		   
		  if(re && re.data!=""){
		     var $ul = $(dom).closest("ul");
		  	 $(dom).html("上传中...");
		   pds.ajaxSubmit({
				url:"attach/upload",
				fileData: {file: re.data},
				success:function(e){
				  if (e) {
		        	var data = e.data;
		        	data.fileBizType = Flag;
			        data.fileBizPk = TaskId;
			        imageMap[Flag] = data;
			        $(dom).remove();
			        $ul.append('<li onclick="imageUpload(this)" class="farmImag"><div class="imgbox2"><img src="'+re.data+'"></div><li>');
			        if($("img").length>=5){
			        	$("#submit").show();
			        }else{
			       		$("#submit").hide();
			        }  
			        } else {
			        $(dom).html("上传失败...");

			         //$ul.append('<li flag="15" bledflag="1" onclick="imageUpload(this)"><div class="imgbox"><i class="icon-plus"></i><p>图片上传</p></div></li>'); 
			        }
				    
				    
				},
				error:function(e){
					alert("服务器异常，请联系管理员!");
				}
			});
	
	////////////////////////////////////////////
	         }else{
		        
		    }
		});
 }
      

	//数据交换
     function save(dom){
     
		var submitFlag = dom.getAttribute("disabledflag");
		    if(submitFlag != 1){
				alert("请勿重复提交");
				return true;
			}
			

         var soiltemp = document.getElementById("soiltemp").value; 
         var weather = document.getElementById("weather").value; 
		 var remarks = document.getElementById("remarks").value;
		 var moisture = document.getElementById("moisture").value;
		 var temperature = document.getElementById("temperature").value;
		 var leaveNum = document.getElementById("leaveNum").value;
		 var cropHeight = document.getElementById("cropHeight").value;
		 var diseasesFlag = document.getElementById("diseasesFlag").value;
		 var pestsFlag = document.getElementById("pestsFlag").value;
		 var weedsFlag = document.getElementById("weedsFlag").value;
		 var cropRemarks = document.getElementById("cropRemarks").value;
		 var leaveDiameter = document.getElementById("leaveDiameter").value;
		// var appFarmlandPic = document.getElementById("appFarmlandPic").value;
	
	     if(weather==""){
	       alert("请输入天气情况");
	       return true;
	     }
	     if(temperature==""){
	       alert("请输入气温情况");
	       return true;
	     }
	     
	     if(cropHeight==""){
	       alert("请输入株高情况");
	       return true;
	     }
	     if(leaveNum==""){
	       alert("请输入叶片数量");
	       return true;
	     }
	     if(leaveDiameter==""){
	       alert("请输入叶面直径");
	       return true;
	     }
	     if(diseasesFlag==""){
	       alert("请输入病害情况");
	       return true;
	     }
	     if(pestsFlag==""){
	       alert("请输入虫害情况");
	       return true;
	     }
	     if(weedsFlag==""){
	       alert("请输入草害情况");
	       return true;
	     }
	     if(cropRemarks==""){
	       alert("请输入注意事项");
	       return true;
	     }
	    
	     if(remarks==""){
	        alert("请输入其它说明");
	        return true;
	     
	     }
	     
	      AppFarmlandDetailData.soilTemp = soiltemp  
	      AppFarmlandDetailData.remarks =remarks;
	      AppFarmlandDetailData.weather = weather;
	     // AppFarmlandDetailData.code = code;
	      AppFarmlandDetailData.leaveNum = leaveNum;
	      AppFarmlandDetailData.temperature = temperature;
	      AppFarmlandDetailData.cropHeight = cropHeight;
	      AppFarmlandDetailData.diseasesFlag = diseasesFlag;
	      AppFarmlandDetailData.pestsFlag = pestsFlag;
	      AppFarmlandDetailData.weedsFlag = weedsFlag;
	      AppFarmlandDetailData.cropRemarks = cropRemarks;
	      AppFarmlandDetailData.leaveDiameter = leaveDiameter;
	      AppFarmlandDetailData.moisture = moisture;
	    
	        
	     if(imageMap){
		  	for(var flag in imageMap){
		  		AppFarmlandDetailData.appFarmlandPic.push(imageMap[flag]);
		  	}
		  }
		
		 AppFarmlandDetailData.farmingTaskId =  TaskId;   

		 pds.ajaxSubmit({
				url:"app/farmland/save",
				data:{value:AppFarmlandDetailData,userId:userId},
				success:function(e){
				
				  if(e.status){
				  
			   		  $(dom).attr("disabledFlag", 00);
			          //停止坐标记录并跳转页面
			          map.stopLocation();	
			          api.setPrefs({
                          key:'loc',
                          value:'loc'
                      });
                      api.closeToWin({
                          name : 'win_home',
                          url : 'win_home.html',
                          pageParam:{value:1},
                          reload:true,
                          animation:{
                              type:"movein",              //动画类型（详见动画类型常量）
                              subType:"from_right",       //动画子类型（详见动画子类型常量）
                              duration:300                //动画过渡时间，默认300毫秒
                          }
                      });
                      //刷新确认单统计数据
                      api.execScript({
                          name:'win_home',
                          frameName: 'frm_field',
                          script: 'apiready();'
                      });
                  }
				},
				error:function(e){
				    $(dom).attr("disabledFlag", 1);
					alert("服务器异常，请联系管理员!");
				}
			});
		}
		</script>
	</body>
</html>